{% extends "admin/hub_base.html" %}

{% block content %}
<div class="mb-8">
    <h1 class="text-4xl font-bold text-white mb-2">User Management</h1>
    <p class="text-gray-400">Manage all users and their accounts</p>
</div>

<!-- Search and Filters -->
<div class="bg-gray-800 rounded-lg p-6 border border-gray-700 mb-6">
    <form method="GET" class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
            <input type="text" name="search" value="{{ search }}" placeholder="Search users..."
                   class="w-full px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white">
        </div>
        <div>
            <select name="status" class="w-full px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white">
                <option value="">All Status</option>
                <option value="active" {% if status == 'active' %}selected{% endif %}>Active</option>
                <option value="inactive" {% if status == 'inactive' %}selected{% endif %}>Inactive</option>
                <option value="verified" {% if status == 'verified' %}selected{% endif %}>Verified</option>
                <option value="unverified" {% if status == 'unverified' %}selected{% endif %}>Unverified</option>
            </select>
        </div>
        <div>
            <button type="submit" class="w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                <i class="fas fa-search mr-2"></i>Filter
            </button>
        </div>
        <div>
            <a href="{{ url_for('admin.users') }}" class="block w-full px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600 text-center">
                <i class="fas fa-redo mr-2"></i>Reset
            </a>
        </div>
    </form>
</div>

<!-- Users Table -->
<div class="bg-gray-800 rounded-lg border border-gray-700 overflow-hidden">
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-700">
            <thead class="bg-gray-900">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">User</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Organization</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Role</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Joined</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-700">
                {% for user in users %}
                <tr id="user-row-{{ user.id }}">
                    <td class="px-6 py-4">
                        <div>
                            <p class="text-white font-medium">{{ user.email }}</p>
                            <p class="text-sm text-gray-400">{{ user.full_name }}</p>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-gray-300">
                        {{ user.organization.name if user.organization else 'N/A' }}
                    </td>
                    <td class="px-6 py-4">
                        <div class="space-y-1">
                            <span class="px-2 py-1 text-xs rounded {% if user.is_active %}bg-green-900 text-green-300{% else %}bg-red-900 text-red-300{% endif %}">
                                {{ 'Active' if user.is_active else 'Blocked' }}
                            </span>
                            {% if user.is_verified %}
                            <span class="px-2 py-1 text-xs rounded bg-blue-900 text-blue-300">Verified</span>
                            {% endif %}
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs rounded {% if user.role == 'admin' %}bg-purple-900 text-purple-300{% else %}bg-gray-700 text-gray-300{% endif %}">
                            {{ user.role }}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-400">
                        {{ user.created_at.strftime('%b %d, %Y') }}
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex space-x-2">
                            <a href="{{ url_for('admin.user_details', user_id=user.id) }}" 
                               class="text-blue-400 hover:text-blue-300" title="View Details">
                                <i class="fas fa-eye"></i>
                            </a>
                            {% if user.role != 'admin' %}
                                {% if user.is_active %}
                                <button onclick="blockUser('{{ user.id }}')" 
                                        class="text-red-400 hover:text-red-300" title="Block User">
                                    <i class="fas fa-ban"></i>
                                </button>
                                {% else %}
                                <button onclick="unblockUser('{{ user.id }}')" 
                                        class="text-green-400 hover:text-green-300" title="Unblock User">
                                    <i class="fas fa-check-circle"></i>
                                </button>
                                {% endif %}
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Pagination -->
{% if pagination.pages > 1 %}
<div class="mt-6 flex justify-center">
    <nav class="inline-flex rounded-lg shadow-sm">
        {% if pagination.has_prev %}
        <a href="?page={{ pagination.prev_num }}&search={{ search }}&status={{ status }}" 
           class="px-4 py-2 bg-gray-800 border border-gray-700 text-gray-300 hover:bg-gray-700 rounded-l-lg">
            Previous
        </a>
        {% endif %}
        <span class="px-4 py-2 bg-gray-900 border-t border-b border-gray-700 text-white">
            Page {{ pagination.page }} of {{ pagination.pages }}
        </span>
        {% if pagination.has_next %}
        <a href="?page={{ pagination.next_num }}&search={{ search }}&status={{ status }}" 
           class="px-4 py-2 bg-gray-800 border border-gray-700 text-gray-300 hover:bg-gray-700 rounded-r-lg">
            Next
        </a>
        {% endif %}
    </nav>
</div>
{% endif %}

<script>
function blockUser(userId) {
    if (!confirm('Are you sure you want to block this user? They will not be able to send emails.')) {
        return;
    }
    
    fetch(`/hub/user/${userId}/block`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error blocking user: ' + error);
    });
}

function unblockUser(userId) {
    if (!confirm('Are you sure you want to unblock this user?')) {
        return;
    }
    
    fetch(`/hub/user/${userId}/unblock`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error unblocking user: ' + error);
    });
}
</script>
{% endblock %}
