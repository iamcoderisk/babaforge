{% extends "admin/hub_base.html" %}

{% block content %}
<div class="mb-8">
    <a href="{{ url_for('admin.users') }}" class="text-purple-400 hover:text-purple-300 mb-4 inline-block">
        ‚Üê Back to Users
    </a>
    <h1 class="text-4xl font-bold text-white mb-2">User Details</h1>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- User Info -->
    <div class="lg:col-span-1">
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700 mb-6">
            <h3 class="text-lg font-semibold text-white mb-4">User Information</h3>
            <div class="space-y-3">
                <div>
                    <p class="text-sm text-gray-400">Email</p>
                    <p class="text-white">{{ user.email }}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-400">Name</p>
                    <p class="text-white">{{ user.full_name or 'N/A' }}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-400">Role</p>
                    <span class="px-2 py-1 text-xs rounded {% if user.role == 'admin' %}bg-purple-900 text-purple-300{% else %}bg-gray-700 text-gray-300{% endif %}">
                        {{ user.role }}
                    </span>
                </div>
                <div>
                    <p class="text-sm text-gray-400">Status</p>
                    <span class="px-2 py-1 text-xs rounded {% if user.is_active %}bg-green-900 text-green-300{% else %}bg-red-900 text-red-300{% endif %}">
                        {{ 'Active' if user.is_active else 'Blocked' }}
                    </span>
                </div>
                <div>
                    <p class="text-sm text-gray-400">Verified</p>
                    <span class="px-2 py-1 text-xs rounded {% if user.is_verified %}bg-blue-900 text-blue-300{% else %}bg-yellow-900 text-yellow-300{% endif %}">
                        {{ 'Yes' if user.is_verified else 'No' }}
                    </span>
                </div>
                <div>
                    <p class="text-sm text-gray-400">Joined</p>
                    <p class="text-white">{{ user.created_at.strftime('%b %d, %Y %H:%M') }}</p>
                </div>
            </div>
            
            {% if user.role != 'admin' %}
            <div class="mt-6 space-y-2">
                {% if user.is_active %}
                <button onclick="blockUser('{{ user.id }}')" 
                        class="w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                    <i class="fas fa-ban mr-2"></i>Block User
                </button>
                {% else %}
                <button onclick="unblockUser('{{ user.id }}')" 
                        class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                    <i class="fas fa-check-circle mr-2"></i>Unblock User
                </button>
                {% endif %}
            </div>
            {% endif %}
        </div>

        {% if org %}
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <h3 class="text-lg font-semibold text-white mb-4">Organization</h3>
            <div class="space-y-3">
                <div>
                    <p class="text-sm text-gray-400">Name</p>
                    <p class="text-white">{{ org.name }}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-400">API Key</p>
                    <p class="text-xs text-gray-500 font-mono">{{ org.api_key[:20] }}...</p>
                </div>
                <div>
                    <p class="text-sm text-gray-400">Status</p>
                    <span class="px-2 py-1 text-xs rounded {% if org.is_active %}bg-green-900 text-green-300{% else %}bg-red-900 text-red-300{% endif %}">
                        {{ 'Active' if org.is_active else 'Blocked' }}
                    </span>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Activity & Stats -->
    <div class="lg:col-span-2">
        <!-- Email Stats -->
        {% if email_stats %}
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700 mb-6">
            <h3 class="text-lg font-semibold text-white mb-4">Email Statistics</h3>
            <div class="grid grid-cols-3 gap-4">
                <div>
                    <p class="text-2xl font-bold text-white">{{ "{:,}".format(email_stats.total) }}</p>
                    <p class="text-sm text-gray-400">Total Sent</p>
                </div>
                <div>
                    <p class="text-2xl font-bold text-green-400">{{ "{:,}".format(email_stats.sent) }}</p>
                    <p class="text-sm text-gray-400">Delivered</p>
                </div>
                <div>
                    <p class="text-2xl font-bold text-red-400">{{ "{:,}".format(email_stats.failed) }}</p>
                    <p class="text-sm text-gray-400">Failed</p>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Domains -->
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700 mb-6">
            <h3 class="text-lg font-semibold text-white mb-4">Domains ({{ domains|length }})</h3>
            {% if domains %}
            <div class="space-y-3">
                {% for domain in domains %}
                <div class="flex justify-between items-center border-b border-gray-700 pb-3">
                    <div>
                        <p class="text-white font-medium">{{ domain.domain_name }}</p>
                        <p class="text-sm text-gray-400">Added {{ domain.created_at.strftime('%b %d, %Y') }}</p>
                    </div>
                    <span class="px-2 py-1 text-xs rounded {% if domain.dns_verified %}bg-green-900 text-green-300{% else %}bg-yellow-900 text-yellow-300{% endif %}">
                        {{ 'Verified' if domain.dns_verified else 'Pending' }}
                    </span>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-gray-400">No domains added yet</p>
            {% endif %}
        </div>

        <!-- Recent Emails -->
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <h3 class="text-lg font-semibold text-white mb-4">Recent Emails</h3>
            {% if recent_emails %}
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead class="bg-gray-900">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-400">Time</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-400">To</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-400">Subject</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-400">Status</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-700">
                        {% for email in recent_emails %}
                        <tr>
                            <td class="px-4 py-2 text-sm text-gray-300">{{ email.created_at.strftime('%m/%d %H:%M') }}</td>
                            <td class="px-4 py-2 text-sm text-gray-300">{{ email.to_email }}</td>
                            <td class="px-4 py-2 text-sm text-gray-300">{{ email.subject[:40] }}</td>
                            <td class="px-4 py-2">
                                <span class="px-2 py-1 text-xs rounded {% if email.status == 'sent' %}bg-green-900 text-green-300{% elif email.status == 'failed' %}bg-red-900 text-red-300{% else %}bg-yellow-900 text-yellow-300{% endif %}">
                                    {{ email.status }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-gray-400">No emails sent yet</p>
            {% endif %}
        </div>
    </div>
</div>

<script>
function blockUser(userId) {
    if (!confirm('Block this user? They will not be able to send emails.')) return;
    
    fetch(`/hub/user/${userId}/block`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
}

function unblockUser(userId) {
    if (!confirm('Unblock this user?')) return;
    
    fetch(`/hub/user/${userId}/unblock`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
}
</script>
{% endblock %}
