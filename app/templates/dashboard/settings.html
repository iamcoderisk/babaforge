{% extends "base.html" %}

{% block title %}Settings - SendBaba{% endblock %}

{% block content %}
<div class="p-6 md:p-8">
    <div class="mb-8">
        <h1 class="text-2xl md:text-3xl font-bold text-gray-900">Settings</h1>
        <p class="text-gray-600 mt-1">Manage your account and organization settings</p>
    </div>
    
    <!-- Settings Tabs -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200">
        <div class="border-b border-gray-200">
            <nav class="flex space-x-8 px-6" aria-label="Tabs">
                <button onclick="switchTab('account')" id="accountTab"
                        class="settings-tab border-b-2 border-purple-600 py-4 px-1 text-sm font-medium text-purple-600">
                    Account
                </button>
                <button onclick="switchTab('organization')" id="organizationTab"
                        class="settings-tab border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700">
                    Organization
                </button>
                <button onclick="switchTab('api')" id="apiTab"
                        class="settings-tab border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700">
                    API Keys
                </button>
            </nav>
        </div>
        
        <!-- Account Settings -->
        <div id="accountContent" class="p-6">
            <div class="max-w-2xl">
                <h2 class="text-lg font-semibold mb-4">Account Information</h2>
                
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                        <input type="email" value="{{ current_user.email }}" disabled 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-500">
                        <p class="text-sm text-gray-500 mt-1">Your email address cannot be changed</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Account Created</label>
                        <input type="text" value="{{ current_user.created_at.strftime('%B %d, %Y') if current_user.created_at else 'N/A' }}" disabled 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-500">
                    </div>
                    
                    <div>
                        <h3 class="text-sm font-medium text-gray-700 mb-2">Change Password</h3>
                        <button class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm font-medium">
                            Change Password
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Organization Settings -->
        <div id="organizationContent" class="p-6 hidden">
            <div class="max-w-2xl">
                <h2 class="text-lg font-semibold mb-4">Organization Settings</h2>
                
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Organization Name</label>
                        <input type="text" value="{{ organization.name if organization else 'N/A' }}" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Organization ID</label>
                        <input type="text" value="{{ organization.id if organization else 'N/A' }}" disabled 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-500">
                    </div>
                    
                    <div>
                        <button class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm font-medium">
                            Save Changes
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- API Settings -->
        <div id="apiContent" class="p-6 hidden">
            <div class="max-w-2xl">
                <h2 class="text-lg font-semibold mb-4">API Keys</h2>
                
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <div class="flex items-start">
                        <i class="fas fa-info-circle text-blue-600 mt-1"></i>
                        <div class="ml-3">
                            <p class="text-sm text-blue-800">Use API keys to authenticate your applications with SendBaba's API.</p>
                        </div>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">API Key</label>
                        <div class="flex gap-2">
                            <input type="password" id="apiKeyInput" value="{{ organization.api_key if organization and organization.api_key else 'No API key generated yet' }}" disabled 
                                   class="flex-1 px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-500 font-mono text-sm">
                            <button onclick="toggleApiKey()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-sm font-medium">
                                <i class="fas fa-eye" id="toggleIcon"></i>
                            </button>
                            <button onclick="copyApiKey()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-sm font-medium" title="Copy">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <button onclick="generateApiKey()" id="generateBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm font-medium">
                            <i class="fas fa-key mr-2"></i>Generate New API Key
                        </button>
                        <p class="text-sm text-gray-500 mt-2">⚠️ Generating a new key will invalidate the old one.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function switchTab(tab) {
    document.getElementById('accountContent').classList.add('hidden');
    document.getElementById('organizationContent').classList.add('hidden');
    document.getElementById('apiContent').classList.add('hidden');
    
    document.querySelectorAll('.settings-tab').forEach(btn => {
        btn.classList.remove('border-purple-600', 'text-purple-600');
        btn.classList.add('border-transparent', 'text-gray-500');
    });
    
    if (tab === 'account') {
        document.getElementById('accountContent').classList.remove('hidden');
        document.getElementById('accountTab').classList.add('border-purple-600', 'text-purple-600');
        document.getElementById('accountTab').classList.remove('border-transparent', 'text-gray-500');
    } else if (tab === 'organization') {
        document.getElementById('organizationContent').classList.remove('hidden');
        document.getElementById('organizationTab').classList.add('border-purple-600', 'text-purple-600');
        document.getElementById('organizationTab').classList.remove('border-transparent', 'text-gray-500');
    } else if (tab === 'api') {
        document.getElementById('apiContent').classList.remove('hidden');
        document.getElementById('apiTab').classList.add('border-purple-600', 'text-purple-600');
        document.getElementById('apiTab').classList.remove('border-transparent', 'text-gray-500');
    }
}

function toggleApiKey() {
    const input = document.getElementById('apiKeyInput');
    const icon = document.getElementById('toggleIcon');
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

function copyApiKey() {
    const input = document.getElementById('apiKeyInput');
    const tempInput = document.createElement('input');
    tempInput.value = input.value;
    document.body.appendChild(tempInput);
    tempInput.select();
    document.execCommand('copy');
    document.body.removeChild(tempInput);
    
    alert('API key copied to clipboard!');
}

function generateApiKey() {
    if (!confirm('Are you sure? This will invalidate your current API key.')) {
        return;
    }
    
    const btn = document.getElementById('generateBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Generating...';
    
    fetch('/api/settings/generate-api-key', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            document.getElementById('apiKeyInput').value = data.api_key;
            alert('New API key generated successfully!');
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to generate API key'));
        }
    })
    .catch(err => {
        alert('Network error: ' + err.message);
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-key mr-2"></i>Generate New API Key';
    });
}
</script>
{% endblock %}
