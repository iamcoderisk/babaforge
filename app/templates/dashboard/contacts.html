{% extends "base.html" %}

{% block title %}Contacts - SendBaba{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-8">
    <div class="mb-8 flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Contacts</h1>
            <p class="text-gray-600 mt-2">Manage your email contacts</p>
        </div>
        <div class="flex space-x-4">
            <button onclick="document.getElementById('importModal').classList.remove('hidden')" 
                    class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                <i class="fas fa-upload mr-2"></i>Import CSV
            </button>
            <button onclick="document.getElementById('addModal').classList.remove('hidden')" 
                    class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                <i class="fas fa-plus mr-2"></i>Add Contact
            </button>
        </div>
    </div>

    <!-- Stats -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600">Total Contacts</p>
                    <p class="text-3xl font-bold text-gray-900">{{ contacts.total if contacts else 0 }}</p>
                </div>
                <div class="text-4xl text-blue-500">ðŸ‘¥</div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600">Active</p>
                    <p class="text-3xl font-bold text-green-600">{{ contacts.total if contacts else 0 }}</p>
                </div>
                <div class="text-4xl text-green-500">âœ“</div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600">Lists</p>
                    <p class="text-3xl font-bold text-purple-600">0</p>
                </div>
                <div class="text-4xl text-purple-500">ðŸ“‹</div>
            </div>
        </div>
    </div>

    <!-- Search and Filter -->
    <div class="bg-white rounded-lg shadow p-4 mb-6">
        <form method="GET" class="flex space-x-4">
            <input type="text" name="search" placeholder="Search contacts..." 
                   class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                   value="{{ request.args.get('search', '') }}">
            <button type="submit" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                <i class="fas fa-search mr-2"></i>Search
            </button>
        </form>
    </div>

    <!-- Contacts Table -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Company</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Added</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                {% if contacts and contacts.items %}
                    {% for contact in contacts.items %}
                    <tr>
                        <td class="px-6 py-4 text-sm text-gray-900">{{ contact.email }}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">
                            {{ contact.first_name or '' }} {{ contact.last_name or '' }}
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-600">{{ contact.company or '-' }}</td>
                        <td class="px-6 py-4 text-sm text-gray-600">
                            {{ contact.created_at.strftime('%b %d, %Y') if contact.created_at else '-' }}
                        </td>
                        <td class="px-6 py-4 text-sm">
                            <button onclick="editContact('{{ contact.id }}')" 
                                    class="text-blue-600 hover:text-blue-700 mr-3">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteContact('{{ contact.id }}')" 
                                    class="text-red-600 hover:text-red-700">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                            No contacts yet. Click "Add Contact" or "Import CSV" to get started.
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if contacts and contacts.pages > 1 %}
    <div class="mt-6 flex justify-center">
        <nav class="inline-flex rounded-lg shadow-sm">
            {% if contacts.has_prev %}
            <a href="?page={{ contacts.prev_num }}" 
               class="px-4 py-2 bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 rounded-l-lg">
                Previous
            </a>
            {% endif %}
            <span class="px-4 py-2 bg-white border-t border-b border-gray-300 text-gray-700">
                Page {{ contacts.page }} of {{ contacts.pages }}
            </span>
            {% if contacts.has_next %}
            <a href="?page={{ contacts.next_num }}" 
               class="px-4 py-2 bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 rounded-r-lg">
                Next
            </a>
            {% endif %}
        </nav>
    </div>
    {% endif %}
</div>

<!-- Add Contact Modal -->
<div id="addModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900">Add New Contact</h3>
        </div>
        <form id="addContactForm" class="p-6 space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                <input type="email" name="email" required
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">First Name</label>
                    <input type="text" name="first_name"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Last Name</label>
                    <input type="text" name="last_name"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Company</label>
                <input type="text" name="company"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
            </div>
            <div class="flex justify-end space-x-3 pt-4">
                <button type="button" onclick="document.getElementById('addModal').classList.add('hidden')"
                        class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                    Cancel
                </button>
                <button type="submit"
                        class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                    Add Contact
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Import CSV Modal -->
<div id="importModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900">Import Contacts from CSV</h3>
        </div>
        <form id="importForm" class="p-6 space-y-4" enctype="multipart/form-data">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">CSV File</label>
                <input type="file" name="file" accept=".csv,.xlsx,.xls" required
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                <p class="text-xs text-gray-500 mt-2">
                    File should have columns: email, first_name, last_name, company
                </p>
            </div>
            <div class="flex justify-end space-x-3 pt-4">
                <button type="button" onclick="document.getElementById('importModal').classList.add('hidden')"
                        class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                    Cancel
                </button>
                <button type="submit"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    Import
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Add contact form submission
document.getElementById('addContactForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData);
    
    fetch('/api/contacts', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Contact added successfully!');
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error adding contact: ' + error);
    });
});

// Import CSV form submission
document.getElementById('importForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    fetch('/api/contacts/import', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Imported ${data.imported} contacts successfully!`);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error importing contacts: ' + error);
    });
});

function editContact(contactId) {
    // TODO: Implement edit functionality
    alert('Edit functionality coming soon!');
}

function deleteContact(contactId) {
    if (!confirm('Are you sure you want to delete this contact?')) {
        return;
    }
    
    fetch(`/api/contacts/${contactId}`, {
        method: 'DELETE',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Contact deleted successfully!');
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error deleting contact: ' + error);
    });
}
</script>
{% endblock %}
